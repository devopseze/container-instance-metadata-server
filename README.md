# container-instance-metadata-server

The `container-instance-metadata-server` emulates the Cloud Run [container instance metadata server](https://cloud.google.com/run/docs/reference/container-contract#metadata-server) for a given [service account](https://cloud.google.com/iam/docs/service-accounts) and user supplied metadata.

## Available metadata server information

```
/computeMetadata/v1/instance/id
/computeMetadata/v1/instance/service-accounts/default/aliases
/computeMetadata/v1/instance/service-accounts/default/email
/computeMetadata/v1/instance/service-accounts/default/token
/computeMetadata/v1/instance/service-accounts/default/identity
/computeMetadata/v1/instance/region
/computeMetadata/v1/instance/zone
/computeMetadata/v1/project/numeric-project-id
/computeMetadata/v1/project/project-id
```

## Usage

```
container-instance-metadata-server -h
```
```
Usage of container-instance-metadata-server:
  -listen-address string
        The HTTP listen address (default "127.0.0.1:8888")
  -metadata string
        Metadata file path (default "metadata.json")
  -service-account string
        Service account file path (default "service-account.json")
```

## Tutorial

Create a metadata configuration file:

```
PROJECT_ID=$(gcloud config get-value project)
```

```
PROJECT_NUMBER=$(gcloud projects describe ${PROJECT_ID} --format="value(projectNumber)")
```

```
cat <<EOF > metadata.json
{
  "instance": {
    "region": "us-west1"
  },
  "project": {
    "numeric_project_id": "${PROJECT_NUMBER}",
    "project_id": "${PROJECT_ID}"
  }
}
EOF
```

Create a service account:

```
gcloud iam service-accounts create metadata-server
```

```
gcloud iam service-accounts keys create service-account.json \
  --iam-account metadata-server@${PROJECT_ID}.iam.gserviceaccount.com
```

Start the `container-instance-metadata-server`:

```
container-instance-metadata-server \
  -metadata metadata.json \
  -service-account service-account.json 
```

```
2020/10/12 09:28:07 Starting Container Instance Metadata Service ...
2020/10/12 09:28:07 Listening on 127.0.0.1:8888
```

### Test

```
curl -i http://127.0.0.1:8888/computeMetadata/v1/instance/region \
  -H "Metadata-Flavor: Google"
```

```
HTTP/1.1 200 OK
Content-Type: application/text
Metadata-Flavor: Google
Server: Metadata Server for Serverless
Date: Mon, 12 Oct 2020 09:35:28 GMT
Content-Length: 8

us-west1
```

> The metadata server logs the request
> `2020/10/12 09:28:46 Handling request for /computeMetadata/v1/instance/region`

## Configuration

* `instance.region` string
* `project.numeric_project_id` string
* `project.project_id` string

### Example

```json
{
  "instance": {
    "region": "us-west1"
  },
  "project": {
    "numeric_project_id": "330612842442",
    "project_id": "hightowerlabs"
  }
}
```

## Routing Traffic

You can also run the metadata server on the same address `169.254.169.254` as Cloud Run does and also map the `metadata.google.internal` domain to that address.

Add a secondary IP address:

```
sudo ip address add 169.254.169.254/24 dev eth0
```

Append the following line to `/etc/hosts`:

```
169.254.169.254 metadata.google.internal
```

Resolve `metadata.google.internal`:

```
getent hosts metadata.google.internal
```

```
169.254.169.254 metadata.google.internal
```

Start the `container-instance-metadata-server`:

```
sudo container-instance-metadata-server \
  -listen-address "169.254.169.254:80" \
  -metadata metadata.json \
  -service-account service-account.json
```

### Test

```
curl -i http://metadata.google.internal/computeMetadata/v1/instance/id \
  -H "Metadata-Flavor: Google"
```

```
HTTP/1.1 200 OK
Content-Type: application/text
Metadata-Flavor: Google
Server: Metadata Server for Serverless
Date: Mon, 12 Oct 2020 16:47:04 GMT
Content-Length: 128

260d7730e06aeeae6c1c235d31b0d4fdf23765c41fd73d06aee75c1d2e6b3c998319301d9ad232169d573e42e1a83a4142bdc18a713d51a25e71f9f6aff64deb
```

> The id is auto generated by `container-instance-metadata-server` at start up.
